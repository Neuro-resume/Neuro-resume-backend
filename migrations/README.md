# Database Migrations

This directory contains Alembic database migrations for the AI Resume Builder project.

## Setup

Migrations are managed using [Alembic](https://alembic.sqlalchemy.org/).

### Prerequisites

-   Python 3.11+
-   PostgreSQL database
-   All dependencies installed (`pip install -r requirements.txt`)
-   `.env` file configured with `DATABASE_URL`

## Usage

Use the convenience script `scripts/migrate.sh` for all migration operations:

### Apply all pending migrations

```bash
./scripts/migrate.sh upgrade
```

### Create a new migration

```bash
./scripts/migrate.sh revision "description of changes"
```

Example:

```bash
./scripts/migrate.sh revision "create users table"
```

### Downgrade to previous revision

```bash
./scripts/migrate.sh downgrade -1
```

Or to a specific revision:

```bash
./scripts/migrate.sh downgrade abc123
```

### View current database revision

```bash
./scripts/migrate.sh current
```

### View migration history

```bash
./scripts/migrate.sh history
```

## Manual Alembic Commands

You can also use Alembic directly:

```bash
# Upgrade to head
alembic upgrade head

# Create new revision
alembic revision --autogenerate -m "description"

# Downgrade one revision
alembic downgrade -1

# Show current revision
alembic current

# Show history
alembic history --verbose
```

## Migration File Structure

```
migrations/
├── env.py              # Alembic environment configuration
├── script.py.mako      # Template for new migrations
└── versions/           # Migration files
    ├── 001_xxx.py
    ├── 002_xxx.py
    └── ...
```

## Best Practices

1. **Always review autogenerated migrations** before applying them
2. **Test migrations on a development database** first
3. **Create descriptive migration messages**
4. **One logical change per migration** (e.g., don't mix table creation with data migration)
5. **Write both upgrade and downgrade functions**
6. **Commit migration files to version control**

## Troubleshooting

### Database URL not found

Ensure your `.env` file contains:

```
DATABASE_URL=postgresql+asyncpg://user:password@localhost:5432/dbname
```

### Import errors in env.py

Make sure all models are imported in `app/db/connection.py` before creating migrations.

### Autogenerate not detecting changes

Ensure your models inherit from `Base` and are imported in the application.
